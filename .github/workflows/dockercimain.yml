name: Docker CI/CD for Flask App

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch
  workflow_dispatch: # Allow manual triggering

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üê≥ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ‚öôÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üè∑Ô∏è Determine Image Tag
        id: image
        run: echo "TAG=${{ secrets.DOCKER_IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: üî® Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.image.outputs.TAG }}, ${{ secrets.DOCKER_IMAGE_NAME }}:latest
          # Caching is essential for faster builds
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üöÄ Run and Test Container
        run: |
          # Pull the image we just pushed
          docker pull ${{ steps.image.outputs.TAG }}
          
          # Run the container in detached mode, mapping port 5000 to 8080
          docker run -d --name login-app -p 8080:5000 ${{ steps.image.outputs.TAG }}

          # Give the app a moment to start
          sleep 5

          # Simple test to check if the app is running and accessible
          response=$(curl -s http://localhost:8080)
          if echo "$response" | grep "Welcome!"; then
            echo "‚úÖ Container is running and responding correctly!"
          else
            echo "‚ùå Container test failed. Response:"
            echo "$response"
            exit 1
          fi
          
          # Stop and remove the container
          docker stop login-app
          docker rm login-app
